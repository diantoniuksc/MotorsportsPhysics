@page "/cornering-quiz"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@implements IDisposable
@using System.Linq

<PageTitle>Cornering Dynamics Quiz</PageTitle>

@if (!StepMode)
{
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-0 pb-8">
    <h1 class="text-2xl font-bold mb-4">Cornering Dynamics Quiz</h1>
    <p class="text-gray-700 mb-6">Answer all questions, then click "Check answers" to see your score and explanations.</p>

    @if (submitted)
    {
      <div class="mb-6 rounded-md border border-primary/30 bg-primary/10 px-4 py-3">
        <p class="font-semibold">Score: @CorrectCount / @questions.Count</p>
        @if (UnansweredCount > 0)
        {
          <p class="text-sm text-gray-700">You left @UnansweredCount question(s) unanswered.</p>
        }
      </div>
    }

    <EditForm Model="this" OnValidSubmit="OnSubmit">
      <DataAnnotationsValidator />

      @foreach (var q in questions)
      {
        var chosen = answers.TryGetValue(q.Id, out var sel) ? sel : (int?)null;
        var isCorrect = submitted && chosen is not null && chosen.Value == q.CorrectIndex;
        var isWrong = submitted && chosen is not null && chosen.Value != q.CorrectIndex;
        var isMissing = submitted && chosen is null;

        <fieldset @key=q.Id class="mb-6 rounded-lg border p-4 @(isCorrect ? "border-green-400 bg-green-50" : isWrong ? "border-red-400 bg-red-50" : isMissing ? "border-amber-400 bg-amber-50" : "border-primary/20 bg-background-light")">
          <legend class="px-1 font-semibold">@q.Number. @q.Text</legend>

          <div class="mt-2 space-y-2">
            @for (int i = 0; i < q.Options.Count; i++)
            {
              var opt = q.Options[i];
              var idx = i;
              var selected = chosen.HasValue && chosen.Value == idx;
              <label class="flex items-start gap-3 rounded-md border border-transparent p-2 hover:bg-primary/10 cursor-pointer">
                <input type="radio" name=@($"q{q.Id}") checked="@selected" @onchange="_ => Select(q.Id, idx)" class="mt-1" />
                <span>@opt</span>
              </label>
            }
          </div>

          @if (submitted)
          {
            <div class="mt-3 text-sm">
              @if (isCorrect)
              {
                <p class="text-green-700 font-medium">Correct.</p>
              }
              else if (isWrong)
              {
                <p class="text-red-700 font-medium">Not quite. Correct answer: <strong>@q.LetterFor(q.CorrectIndex)</strong></p>
              }
              else if (isMissing)
              {
                <p class="text-amber-700 font-medium">Answer required. Correct answer: <strong>@q.LetterFor(q.CorrectIndex)</strong></p>
              }

              <div class="mt-2 text-gray-800">
                @((MarkupString)q.GetExplanationHtml())
              </div>
            </div>
          }
        </fieldset>
      }

      <div class="flex gap-3">
        <button type="submit" class="rounded-md bg-primary px-4 py-2 font-semibold text-white hover:bg-opacity-90">Check answers</button>
        <button type="button" class="rounded-md border px-4 py-2 font-semibold hover:bg-gray-50" @onclick="Reset">Reset</button>
      </div>
    </EditForm>
  </div>
}
else
{
  @if (!finished)
  {
    var q = questions[current];
    var chosen = answers.TryGetValue(q.Id, out var sel) ? sel : (int?)null;
    var isCorrect = stepChecked && chosen is not null && chosen.Value == q.CorrectIndex;
    var isWrong = stepChecked && chosen is not null && chosen.Value != q.CorrectIndex;
    var isMissing = stepChecked && chosen is null;

    <div class="bg-background-light rounded-lg border border-primary/20 shadow-lg p-6 max-w-6xl mx-auto">
      @if (RaceMode || Timed)
      {
        <div class="mb-4 flex items-center justify-between">
          @if (Timed)
          {
            <div class="text-sm font-semibold text-primary">Time left: @timeLeft s</div>
          }
          <div class="flex-1 mx-4 h-3 rounded-full bg-primary/10 overflow-hidden">
            <div class="h-full bg-primary/60" style=@($"width:{Math.Round(userProgress*100)}%")></div>
          </div>
          <div class="text-xs text-gray-600">You</div>
        </div>
        <div class="space-y-2 mb-4">
          @for (int i = 0; i < foes.Length; i++)
          {
            var label = (RivalLabels is not null && i < RivalLabels.Length && !string.IsNullOrWhiteSpace(RivalLabels[i]))
              ? RivalLabels[i]
              : $"Rival {i+1}";
            <div class="flex items-center gap-2">
              <div class="flex-1 h-2 rounded-full bg-gray-200 overflow-hidden">
                <div class="h-full bg-gray-500" style=@($"width:{Math.Round(foes[i]*100)}%")></div>
              </div>
              <span class="text-xs text-gray-500">@label</span>
            </div>
          }
        </div>
      }
      <div class="grid gap-6 md:grid-cols-5 md:items-start">
        <div class="md:col-span-2">
          <p class="text-primary font-bold text-sm mb-1">Question @(@current + 1)/@questions.Count</p>
          <p class="text-lg font-bold text-gray-800">@q.Text</p>
        </div>
  <div class="w-full md:col-span-3 space-y-3">
          @for (int i = 0; i < q.Options.Count; i++)
          {
            var opt = q.Options[i];
            var idx = i;
            var selected = chosen.HasValue && chosen.Value == idx;
            <label class="flex items-center gap-4 rounded-lg border border-primary/20 p-4 hover:bg-primary/10 cursor-pointer transition-all">
              <input type="radio" name=@($"q{q.Id}") class="h-5 w-5" checked="@selected" @onchange="_ => Select(q.Id, idx)" />
              <span class="text-sm font-medium">@opt</span>
            </label>
          }
        </div>
      </div>

      @if (stepChecked)
      {
        <div class="mt-4 text-sm">
          @if (isCorrect)
          {
            <p class="text-green-700 font-semibold">Correct.</p>
          }
          else if (isWrong)
          {
            <p class="text-red-700 font-semibold">Not quite. Correct answer: <strong>@q.LetterFor(q.CorrectIndex)</strong></p>
          }
          else if (isMissing)
          {
            <p class="text-amber-700 font-semibold">Answer required. Correct answer: <strong>@q.LetterFor(q.CorrectIndex)</strong></p>
          }
          @if (ShowExplanation)
          {
            <div class="mt-2 text-gray-800">@((MarkupString)q.GetExplanationHtml())</div>
          }
        </div>
      }

      <div class="flex justify-center mt-6 gap-3">
        @if (!stepChecked)
        {
          <button class="w-full md:w-auto flex min-w-[120px] items-center justify-center rounded-lg h-11 px-6 bg-primary text-white text-sm font-bold tracking-wider disabled:opacity-50"
                  disabled="@(chosen is null)" @onclick="CheckCurrent">
            <span>Check answer</span>
          </button>
        }
        else
        {
          var isLast = current >= questions.Count - 1;
          var canFinish = !RaceMode || !isLast || (userProgress >= 0.999 && foes.All(f => f >= 0.999));
          <button class="w-full md:w-auto flex min-w-[120px] items-center justify-center rounded-lg h-11 px-6 bg-primary text-white text-sm font-bold tracking-wider disabled:opacity-50"
                  disabled="@(!canFinish)" @onclick="Next">
            <span>@(isLast ? "Finish" : "Next")</span>
          </button>
        }
      </div>
    </div>
  }
  else
  {
    <div class="max-w-3xl mx-auto rounded-lg border border-primary/30 bg-primary/10 px-4 py-6 text-center">
      <p class="text-xl font-semibold">Score: @CorrectCount / @questions.Count</p>
      @if (_elapsed.HasValue && _showElapsed)
      {
        <p class="mt-2 text-gray-800">Time to complete: <strong>@_elapsed.Value.ToString(@"m\:ss")</strong></p>
      }
      else if (finished && !_showElapsed)
      {
        <p class="mt-2 text-gray-600 text-sm">Waiting for car to complete the final lap…</p>
      }
      @if (RaceMode && _showElapsed)
      {
            if (_externalPlacement.HasValue)
            {
              var pos = _externalPlacement!.Value;
              var tot = Math.Max(1, _externalTotalCars > 0 ? _externalTotalCars : foes.Length + 1);
              <p class="mt-2 text-gray-800 font-medium">
                Race result: @(pos == 1 ? "You won!" : $"You finished {pos} of {tot}")
              </p>
            }
            else
            {
              var placement = 1 + foes.Count(f => f > userProgress);
              <p class="mt-2 text-gray-800 font-medium">
                Race result: @(placement == 1 ? "You won!" : $"You finished {placement} of {foes.Length + 1}")
              </p>
            }
      }
      <div class="mt-4 flex justify-center gap-3">
        <button class="rounded-lg border px-4 py-2 font-semibold hover:bg-gray-50" @onclick="ResetAndStart">Try again</button>
        <a class="rounded-lg bg-primary text-white px-4 py-2 font-semibold" href="/race-menu">Back to menu</a>
      </div>
    </div>
  }
}

@code {
  private bool submitted = false;
  private Dictionary<int, int> answers = new();
  [Parameter] public bool StepMode { get; set; } = false;
  [Parameter] public bool ShowExplanation { get; set; } = true;
  [Parameter] public bool RaceMode { get; set; } = false;
  [Parameter] public bool Timed { get; set; } = false;
  // Difficulty label passed by parent (e.g., "Easy", "Medium", "High"). Default Easy.
  [Parameter] public string Difficulty { get; set; } = "Easy";
  // Topic key (e.g., "cornering", "aerodynamics", "acceleration", "topspeed", "downforce"). Default cornering
  [Parameter] public string Topic { get; set; } = "cornering";
  // When true (default), the quiz in StepMode will auto-start on first render.
  // Set to false to defer starting until the parent explicitly calls StartFromParent().
  [Parameter] public bool AutoStart { get; set; } = true;
  // Raised when a step (question) is shown; argument is 1-based step number
  [Parameter] public EventCallback<int> OnStepStarted { get; set; }
  // Raised whenever the current question becomes answered or unanswered
  [Parameter] public EventCallback<bool> OnAnswerStateChanged { get; set; }
  // Raised when the user presses "Check answer" in StepMode indicating whether it was correct
  [Parameter] public EventCallback<bool> OnAnswerChecked { get; set; }
  // Raised with total answered count whenever it changes (counts any answered, not only correct)
  [Parameter] public EventCallback<int> OnAnsweredCountChanged { get; set; }
  // Raised when the user completes all questions in StepMode; parent can wait for race finish
  [Parameter] public EventCallback OnFinished { get; set; }
  [Parameter] public int TimeLimitSeconds { get; set; } = 90;
  private int current = 0;
  private bool stepChecked = false;
  private bool finished = false;
  private bool started = false;
  private DateTime? _startedUtc;
  private DateTime? _finishedUtc;
  private TimeSpan? _elapsed;
  private bool _showElapsed = false;
  private int? _externalPlacement;
  private int _externalTotalCars = 0;
  private int timeLeft;
  private System.Timers.Timer? _timer;
  private double userProgress = 0; // 0..1
  [Parameter] public string[] RivalLabels { get; set; } = System.Array.Empty<string>();
  // Five rivals' relative progress (0..1) and per-step base pace multipliers (matches Medium race cars)
  private double[] foes = new double[5] { 0, 0, 0, 0, 0 };
  private double[] foeBase = new double[5] { 0.95, 0.92, 0.90, 0.88, 0.85 }; // relative pace per question step
  private readonly Random _rng = new Random();
  // Tracks which question IDs have been explicitly submitted (via Check answer) in StepMode
  private HashSet<int> committed = new();

  // The active list of questions for the current difficulty
  private List<Question> questions = new();

  // --- Aerodynamics question sets ---
  private readonly List<Question> _aeroEasy = new()
  {
    new(1, "What does aerodynamic downforce do?", new(){"A) Decreases tire grip","B) Pushes the car into the track for more grip","C) Reduces braking force","D) Increases fuel usage"}, 1,
      explanationHtml: "Downforce increases the normal force on the tires, raising potential friction for cornering and braking."),
    new(2, "Which part mainly generates front downforce?", new(){"A) Rear wing","B) Front wing","C) Floor diffuser","D) Mirrors"}, 1),
    new(3, "What is 'drag' in aerodynamics?", new(){"A) Force aiding motion","B) Force opposing motion","C) Force turning the car","D) Force lifting the car"}, 1),
    new(4, "DRS primarily reduces which force?", new(){"A) Downforce","B) Drag","C) Gravity","D) Tire friction"}, 1),
    new(5, "Why are F1 floors important?", new(){"A) Cooling only","B) Generate ground-effect downforce","C) Hold batteries","D) Sound insulation"}, 1),
    new(6, "'Dirty air' causes what?", new(){"A) More downforce","B) Less downforce for the following car","C) Better cooling","D) Higher grip"}, 1),
    new(7, "What happens to downforce with speed?", new(){"A) Usually increases","B) Stays constant","C) Decreases","D) Flips direction"}, 0),
    new(8, "Which angle matters for wing load?", new(){"A) Camber","B) Angle of attack","C) Toe","D) Caster"}, 1),
    new(9, "Sidepods help mainly with?", new(){"A) Braking","B) Flow management & cooling","C) Steering","D) Refueling"}, 1),
    new(10, "High downforce setup is best for?", new(){"A) Long straights","B) Tight corners","C) Drag races","D) Fuel saving only"}, 1),
  };

  private readonly List<Question> _aeroMedium = new()
  {
    new(1, "Increasing rear wing angle typically…", new(){"A) Lowers cornering grip","B) Increases downforce but adds drag","C) Removes drag","D) Has no effect"}, 1),
    new(2, "A well-sealed floor edge does what?", new(){"A) Reduces ground effect","B) Increases underfloor suction","C) Increases lift","D) Only affects cooling"}, 1),
    new(3, "In yaw, aero balance tends to shift…", new(){"A) Forward","B) Rearward","C) Not at all","D) Randomly"}, 0),
    new(4, "Which increases straight-line speed most?", new(){"A) More downforce","B) Less drag","C) More camber","D) Higher tire pressure"}, 1),
    new(5, "Vortex generators are used to…", new(){"A) Add lift","B) Energize boundary layer to delay separation","C) Cool brakes","D) Inflate tires"}, 1),
    new(6, "Porpoising is…", new(){"A) Tyre graining","B) Aero oscillation from ground effect stall/recovery","C) Engine knock","D) Brake fade"}, 1),
    new(7, "High rake in older cars tended to…", new(){"A) Increase underfloor expansion ratio","B) Reduce diffuser performance","C) Remove drag entirely","D) Freeze aero"}, 0),
    new(8, "Following closely reduces…", new(){"A) Drag only","B) Downforce on the following car","C) Tire temperature","D) Brake temps"}, 1),
    new(9, "Front wing flaps mainly tune…", new(){"A) Top speed","B) Aero balance & front downforce","C) Fuel mix","D) Suspension kinematics"}, 1),
    new(10, "At Silverstone you typically choose…", new(){"A) Max drag","B) Higher downforce for fast bends","C) No downforce","D) Only DRS"}, 1),
  };

  private readonly List<Question> _aeroHigh = new()
  {
    new(1, "A diffuser’s expansion ratio governs…", new(){"A) Pressure recovery & suction strength","B) Fuel consumption","C) Brake bias","D) Camber wear"}, 0),
    new(2, "Ground clearance sensitivity means…", new(){"A) DF rises linearly","B) DF collapses near stall heights","C) DF unaffected by ride","D) DF only at rear"}, 1),
    new(3, "Wheel wake control targets…", new(){"A) Straight-line braking","B) Outwash/inwash to protect floor","C) Suspension kinematics","D) Tyre heating only"}, 1),
    new(4, "Aero map ‘balance migration’ with speed…", new(){"A) Moves rearward only","B) Moves forward or rear depending on setup","C) Fixed","D) Non-physical"}, 1),
    new(5, "Effective AoA under yaw typically…", new(){"A) Increases local stall risk","B) Reduces lift only","C) Removes vortices","D) Unrelated"}, 0),
    new(6, "Beam wing reintroduction aids…", new(){"A) Drag only","B) Diffuser performance and DF","C) Fuel mixing","D) ERS deployment"}, 1),
    new(7, "Upwash behind rear wing affects…", new(){"A) DRS rules","B) Slipstream strength & wake size","C) Brake temps","D) Tyre blankets"}, 1),
    new(8, "Flow separation over a wing arises when…", new(){"A) Boundary layer can’t overcome adverse pressure gradient","B) Tires overheat","C) Fuel is low","D) Suspension rolls"}, 0),
    new(9, "Ride height rake tuning in ground effect optimizes…", new(){"A) Diffuser expansion and sealing","B) Steering torque","C) ERS regen","D) Gear ratios"}, 0),
    new(10, "Downforce vs. drag efficiency metric is…", new(){"A) L/D","B) μ","C) Cp","D) Cw"}, 0),
  };

  // --- Acceleration & Power question sets ---
  private readonly List<Question> _accelEasy = new()
  {
    new(1, "Which improves 0–100 km/h most?", new(){"A) More mass","B) More traction","C) Flat battery","D) Narrow tires"}, 1),
    new(2, "Power is…", new(){"A) Energy/time","B) Force·distance","C) Mass·acceleration","D) Speed/time"}, 0),
    new(3, "Launch control helps by…", new(){"A) Increasing fuel","B) Managing wheelspin","C) Cooling brakes","D) Reducing drag"}, 1),
    new(4, "Torque at wheels depends on…", new(){"A) Gear ratio","B) Tire radius","C) Both A and B","D) None"}, 2),
    new(5, "ERS gives…", new(){"A) Extra electric power","B) Extra braking only","C) Less traction","D) More drag"}, 0),
    new(6, "Traction limit is set by…", new(){"A) μ·N","B) ρ·V","C) P=F·v","D) m·g"}, 0),
    new(7, "Shift lights prompt…", new(){"A) Earlier braking","B) Optimal upshifts","C) DRS use","D) Pit stop"}, 1),
    new(8, "Grippy surface means…", new(){"A) Smaller μ","B) Larger μ","C) No change","D) Less N"}, 1),
    new(9, "Cold tires cause…", new(){"A) More grip","B) Less grip","C) No effect","D) Explosions"}, 1),
    new(10, "Shorter gearing usually…", new(){"A) Helps initial acceleration","B) Lowers torque","C) Reduces traction","D) Slows launch"}, 0),
  };

  private readonly List<Question> _accelMedium = new()
  {
    new(1, "Best launch is achieved when…", new(){"A) Wheels don’t slip at all","B) Small controlled slip near μ peak","C) Maximum burnout","D) Full throttle only"}, 1),
    new(2, "Power-to-weight affects…", new(){"A) Top speed only","B) Acceleration strongly","C) Braking only","D) Cornering only"}, 1),
    new(3, "Turbo lag is…", new(){"A) ERS delay","B) Boost response delay","C) Tire warmup","D) Brake fade"}, 1),
    new(4, "Hybrid deployment strategy aims to…", new(){"A) Waste energy","B) Maximize average lap time","C) Lower corner speed","D) Reduce torque"}, 1),
    new(5, "Traction control would…", new(){"A) Cut power on slip","B) Increase drag","C) Heat tires","D) Lock brakes"}, 0),
    new(6, "Wheelspin means…", new(){"A) Slip ratio too high","B) Slip angle zero","C) Understeer","D) Perfect traction"}, 0),
    new(7, "At Spa, climb to Kemmel is limited by…", new(){"A) Pure power and aero drag","B) Apex speed only","C) Brake balance","D) Camber"}, 0),
    new(8, "Anti-stall protects…", new(){"A) Gearbox","B) Engine from stalling","C) Diffuser","D) DRS"}, 1),
    new(9, "More rear weight at launch…", new(){"A) Increases rear traction","B) Decreases traction","C) No effect","D) Breaks gearbox"}, 0),
    new(10, "Slip ratio is…", new(){"A) (wheel speed - ground)/ground","B) Lateral slip","C) Camber thrust","D) Yaw rate"}, 0),
  };

  private readonly List<Question> _accelHigh = new()
  {
    new(1, "Max acceleration on flat is limited by…", new(){"A) μ·g","B) ρ·v²","C) Crr","D) Cp"}, 0),
    new(2, "Power limits acceleration when…", new(){"A) Traction-limited region","B) At higher speeds","C) At zero speed","D) In corners only"}, 1),
    new(3, "Optimal shift strategy minimizes…", new(){"A) Time lost off-peak power","B) Fuel","C) Tire wear only","D) ERS"}, 0),
    new(4, "Limited-slip differential helps by…", new(){"A) Locking wheels fully","B) Biasing torque to gripping wheel","C) Increasing drag","D) Cooling brakes"}, 1),
    new(5, "ERS MGU-K deploy limit is…", new(){"A) Regulated per lap","B) Uncapped","C) Negative","D) Suspended"}, 0),
    new(6, "Tyre longitudinal μ vs slip ratio…", new(){"A) Peaks then falls","B) Monotonic rising","C) Zero always","D) Random"}, 0),
    new(7, "Elevation change affects…", new(){"A) Normal load and available traction","B) Nothing","C) Only aero","D) ERS only"}, 0),
    new(8, "Drag force is…", new(){"A) 1/2 ρ Cd A v²","B) μ·N","C) m·g","D) P/t"}, 0),
    new(9, "Optimal launch clutch slip…", new(){"A) Zero","B) Non-zero to stay near μ peak","C) Infinite","D) Reverse"}, 1),
    new(10, "Traction circle links…", new(){"A) Longitudinal & lateral tire limits","B) Fuel & ERS","C) Aero & yaw","D) Brake temp & wear"}, 0),
  };

  // --- Top speed & Slipstream ---
  private readonly List<Question> _topEasy = new()
  {
    new(1, "Slipstreaming reduces…", new(){"A) Drag","B) Downforce","C) Fuel","D) Grip"}, 0),
    new(2, "Top speed depends largely on…", new(){"A) Drag and power","B) Tire color","C) Brake size","D) Fuel octane"}, 0),
    new(3, "DRS helps by…", new(){"A) Closing wing","B) Opening flap to cut drag","C) More mass","D) Heating tires"}, 1),
    new(4, "Long straights favor…", new(){"A) Low-drag setup","B) High downforce","C) Nothing","D) Heavy fuel"}, 0),
    new(5, "Speedometer measures…", new(){"A) Acceleration","B) Instant speed","C) Fuel","D) G-forces"}, 1),
    new(6, "CdA is…", new(){"A) Drag coefficient × area","B) Corner radius","C) Tyre stiffness","D) Brake bias"}, 0),
    new(7, "Speed vs power at v∞…", new(){"A) P ∝ v³ for drag","B) P ∝ v","C) P ∝ v²","D) P ∝ 1/v"}, 0),
    new(8, "Monza rewards…", new(){"A) High drag","B) Low drag","C) No gear shifts","D) Slow apexes"}, 1),
    new(9, "Tucking behind increases…", new(){"A) Air resistance","B) Slipstream benefit","C) Tyre wear","D) Brake temp"}, 1),
    new(10, "Wind direction can…", new(){"A) Change effective drag","B) Only cool engine","C) Do nothing","D) Change tire color"}, 0),
  };

  private readonly List<Question> _topMedium = new()
  {
    new(1, "Drag force formula is…", new(){"A) 1/2 ρ C_d A v²","B) μ·N","C) m·g","D) Cp"}, 0),
    new(2, "Lower wing angle usually…", new(){"A) Increases drag","B) Reduces drag and downforce","C) No change","D) Only heats tires"}, 1),
    new(3, "Slipstream length depends on…", new(){"A) Wake size and speed","B) Tire type","C) Fuel","D) Brake bias"}, 0),
    new(4, "Gearing for v_max tends to…", new(){"A) Match power peak","B) Random","C) Match torque peak","D) Never shift"}, 0),
    new(5, "Crosswind can…", new(){"A) Add side force","B) Increase μ","C) Lower mass","D) Reduce gravity"}, 0),
    new(6, "ERS helps v_max mostly by…", new(){"A) Adding power on straights","B) Reducing drag","C) Cooling tires","D) Adding mass"}, 0),
    new(7, "Engine mapping affects…", new(){"A) Torque delivery & response","B) Aerodynamics","C) Tyre compound","D) Ride height only"}, 0),
    new(8, "Tyre pressure at top speed…", new(){"A) Influences rolling resistance","B) Sets camber","C) Sets yaw","D) Sets porpoise"}, 0),
    new(9, "Brake ducts taped reduce…", new(){"A) Cooling drag but risk temp rise","B) Lift","C) Mass","D) Yaw"}, 0),
    new(10, "Monza setup aims for…", new(){"A) Max downforce","B) Balanced low drag","C) Wet trim only","D) Anti-DRS"}, 1),
  };

  private readonly List<Question> _topHigh = new()
  {
    new(1, "At v∞, P_required roughly scales with…", new(){"A) v","B) v²","C) v³","D) 1/v"}, 2),
    new(2, "Laminar→turbulent transition can…", new(){"A) Reduce separation over certain shapes","B) Eliminate drag","C) Freeze μ","D) Remove lift"}, 0),
    new(3, "Minimum drag is reached when…", new(){"A) Downforce=0","B) D/(L) efficiency optimized for track","C) ERS full","D) Tyres cold"}, 1),
    new(4, "Slipstream overtake timing aims to…", new(){"A) Finish pass before braking zone","B) Start pass mid-corner","C) Lift off early","D) Avoid DRS"}, 0),
    new(5, "CdA reduction of 5% changes v∞ by ≈…", new(){"A) ~1.6%","B) ~5%","C) ~3%","D) ~10%"}, 0,
      explanationHtml: "Since P ∝ v³ and P ∝ CdA, v ∝ (1/CdA)^(1/3). A 5% drop in CdA yields about 1.6% gain in v∞."),
    new(6, "Yawed flow on straights produces…", new(){"A) Side force and asymmetric drag","B) No effect","C) More lift only","D) Pure downforce"}, 0),
    new(7, "ERS harvest vs deploy balance aims to…", new(){"A) Maximise lap average power","B) Randomize torque","C) Heat tires","D) Cool fuel"}, 0),
    new(8, "Rolling resistance power scales ~ with…", new(){"A) v","B) v²","C) v³","D) 1/v"}, 0),
    new(9, "Wake management devices target…", new(){"A) Reduce base drag and improve flow attachment","B) Cooling only","C) Braking only","D) Steering only"}, 0),
    new(10, "DRS legality box defines…", new(){"A) Geometric limits of the flap opening","B) Tyre pressures","C) Lap count","D) ERS limits"}, 0),
  };

  // Easy (and default) question set
  private readonly List<Question> _easyQuestions = new()
  {
    new(1, "What is the difference between understeer and oversteer?",
      new() {
        "A) Understeer happens when the rear tires lose grip first, oversteer when the front tires lose grip first",
        "B) Understeer happens when the front tires lose grip first, oversteer when the rear tires lose grip first",
        "C) Both understeer and oversteer mean all tires lose grip at the same time",
        "D) Oversteer and understeer are the same phenomenon"
      }, 1,
      explanationHtml: "Understeer: front tires saturate first so the car runs wide. Oversteer: rear tires saturate first so the rear steps out."),

    new(2, "Which force keeps a car moving in a circular path during cornering?",
      new() { "A) Centrifugal force", "B) Centripetal force", "C) Inertia", "D) Gravitational force" }, 1,
      explanationHtml: "Centripetal force acts toward the center of the turn to continuously change the car’s direction."),

    new(3, "Why do Formula 1 cars rely heavily on aerodynamic downforce when cornering?",
      new() { "A) To reduce fuel consumption", "B) To increase tire wear", "C) To increase grip and allow higher cornering speeds", "D) To decrease car weight" }, 2,
      explanationHtml: "Downforce increases normal load on the tires, increasing available frictional (lateral) force without increasing mass."),

    new(4, "A car of mass 800 kg takes a corner of radius 50 m at 20 m/s. What is the required centripetal force?",
      new() { "A) 3,200 N", "B) 4,800 N", "C) 6,400 N", "D) 64,000 N" }, 2,
      calculation: q => {
        double m=800, v=20, r=50; var Fc = m * v * v / r; // 6400 N
        return $"Centripetal force F = m v^2 / r = 800 · 20^2 / 50 = 800 · 400 / 50 = 320,000 / 50 = <strong>{Fc:N0} N</strong>.";
      }),

    new(5, "What limits the maximum speed at which a car can safely take a corner?",
      new() { "A) Engine power", "B) Tire grip (friction coefficient)", "C) Car weight", "D) Aerodynamic drag" }, 1,
      explanationHtml: "Maximum cornering is limited when required lateral force m v^2 / r reaches the tire friction limit μ N (grip)."),

    new(6, "Why do racing cars use wider tires than normal road cars?",
      new() { "A) To look more aggressive", "B) To reduce air resistance", "C) To increase the contact patch and improve grip", "D) To reduce suspension stiffness" }, 2,
      explanationHtml: "Wider tires generally enable a larger, more stable contact patch and better heat management, improving usable grip."),

    new(7, "What happens to weight distribution during cornering?",
      new() { "A) More weight transfers to the inside tires", "B) More weight transfers to the outside tires", "C) Weight distribution stays the same", "D) Weight transfers to the rear tires" }, 1,
      explanationHtml: "Lateral acceleration causes load transfer to the outside tires via the suspension and roll geometry."),

    new(8, "If μ = 1.2, corner radius = 40 m, g = 9.81 m/s², what is the maximum safe cornering speed?",
      new() { "A) 15.6 m/s", "B) 21.7 m/s", "C) 30.5 m/s", "D) 35.0 m/s" }, 1,
      calculation: q => {
        double mu=1.2, r=40, g=9.81; var v = Math.Sqrt(mu * g * r); // ~21.7
        return $"Speed limit from μ g r = v² → v = √(μ g r) = √(1.2 · 9.81 · 40) = √(470.88) ≈ <strong>{v:F1} m/s</strong>.";
      }),

    new(9, "What role does the suspension system play in cornering dynamics?",
      new() { "A) Increases top speed", "B) Maintains tire contact with the road for better grip", "C) Reduces aerodynamic drag", "D) Transfers engine power to the wheels" }, 1,
      explanationHtml: "Suspension geometry and damping keep tires in good contact and manage load transfer for predictable grip."),

    new(10, "Why do racing drivers take a “racing line” through corners?",
      new() { "A) To make the corner longer, reducing sharpness", "B) To stay closer to the audience", "C) To save tire life", "D) To reduce the need for braking completely" }, 0,
      explanationHtml: "A wider radius reduces required lateral acceleration (m v^2 / r), enabling higher corner speed and stability."),
  };

  // Medium question set (user-provided list)
  private readonly List<Question> _mediumQuestions = new()
  {
    new(1, "What does the term \"slip angle\" describe in cornering?",
      new() {
        "A) The angle between the car’s direction of travel and the steering wheel position",
        "B) The angle between the tire’s actual path and its pointing direction",
        "C) The angle of the car’s roll while cornering",
        "D) The maximum angle a car can turn before skidding"
      }, 1),

    new(2, "What happens when a driver enters a corner too fast?",
      new() {
        "A) The car always spins",
        "B) The car tends to understeer or oversteer, depending on grip",
        "C) The car automatically stabilizes due to inertia",
        "D) The tires gain more grip"
      }, 1),

    new(3, "Why is the apex important when taking a racing corner?",
      new() {
        "A) It is the point where braking starts",
        "B) It minimizes the steering input needed",
        "C) It reduces engine wear",
        "D)  It is the point closest to the inside of the corner that helps optimize speed"
      }, 3),

    new(4, "What is trail braking in racing?",
      new() {
        "A) Braking only before the corner",
        "B) Braking throughout the entire straight",
        "C) Gradually releasing the brake while entering the corner",
        "D) Using the handbrake to initiate cornering"
      }, 2),

    new(5, "Which of these factors increases cornering grip?",
      new() {
        "A) Increased aerodynamic downforce",
        "B) Lower car mass",
        "C)  Higher tire pressure",
        "D) Shorter wheelbase"
      }, 0),

    new(6, "What happens to lateral acceleration when corner radius decreases but speed stays the same?",
      new() {
        "A) It decreases",
        "B) It increases",
        "C) It stays the same",
        "D) It becomes zero"
      }, 1),

    new(7, "What role does camber angle play in cornering?",
      new() {
        "A) It affects tire temperature",
        "B) It reduces braking distance",
        "C) It optimizes tire contact patch for better grip",
        "D) It increases aerodynamic drag"
      }, 2),

    new(8, "Why do cars lean outward during a turn?",
      new() {
        "A) Due to aerodynamic forces",
        "B) Due to centrifugal effect (inertia)",
        "C) Due to reduced tire pressure",
        "D) Due to suspension stiffness"
      }, 1),

    new(9, "Which cornering technique helps maintain maximum speed through a curve?",
      new() {
        "A) Braking late and accelerating early",
        "B) Taking a wide entry, hitting the apex, and wide exit",
        "C) Steering sharply into the corner",
        "D) Reducing steering angle completely"
      }, 1),

    new(10, "Why is tire load sensitivity important in cornering?",
      new() {
        "A) Because tires generate more grip as load increases, but not proportionally",
        "B) Because tires lose grip with increased load",
        "C) Because load has no effect on grip",
        "D) Because load sensitivity only applies to braking"
      }, 0),
  };

  // High (Hard) question set
  private readonly List<Question> _highQuestions = new()
  {
    new(1, "Which factor most influences the optimal slip angle of an F1 tire in a corner?",
      new() {
        "A) Tire compound stiffness",
        "B) Driver steering input speed",
        "C) Track elevation",
        "D) Fuel tank size"
      }, 0),

    new(2, "When drivers talk about “rotation” in the middle of a corner, what are they referring to?",
      new() {
        "A) Wheel spin",
        "B) The car’s yaw angle change",
        "C) Steering wheel turning radius",
        "D) Brake disc rotation"
      }, 1),

    new(3, "Why do high-speed corners often require less steering angle than slow corners?",
      new() {
        "A) Tires overheat at low speeds",
        "B) Aerodynamic downforce increases grip at higher speeds",
        "C) Steering systems are speed-sensitive",
        "D) Fuel load drops in fast corners"
      }, 1),

    new(4, "How does increasing rear wing angle affect cornering?",
      new() {
        "A) Increases downforce, improves cornering but reduces top speed",
        "B) Decreases downforce, improves top speed but reduces cornering grip",
        "C) Has no effect on cornering",
        "D) Only affects tire wear"
      }, 0),

    new(5, "Why do banked corners (positive camber) allow higher cornering speeds?",
      new() {
        "A) They reduce centrifugal force",
        "B) They reduce car weight",
        "C) They provide an additional component of normal force acting toward the center of the turn",
        "D) They reduce aerodynamic drag"
      }, 2),

    new(6, "At very high lateral G-forces, which part of the tire works hardest to maintain grip?",
      new() {
        "A) Center tread",
        "B) Inner shoulder",
        "C) Outer shoulder",
        "D) Sidewall"
      }, 2),

    new(7, "Why do F1 engineers analyze “minimum speed at apex” data?",
      new() {
        "A) It shows engine efficiency",
        "B) It predicts tire degradation",
        "C) It reveals driver’s cornering efficiency",
        "D) It determines pit stop strategy"
      }, 2),

    new(8, "What is the main aerodynamic challenge of following another car closely through a corner?",
      new() {
        "A) Increased drag",
        "B) Reduced downforce due to dirty air",
        "C) Sudden tire overheating",
        "D) Steering wheel vibrations"
      }, 1),

    new(9, "Which driving technique helps reduce mid-corner understeer?",
      new() {
        "A) Short-shifting",
        "B) Lifting the throttle slightly",
        "C) Harder braking",
        "D) Straight-line acceleration"
      }, 1),

    new(10, "Why are progressive steering inputs important in high-speed cornering?",
      new() {
        "A) To cool the tires evenly",
        "B) To prevent sudden loss of grip",
        "C) To reduce brake wear",
        "D) To keep DRS active"
      }, 1),
  };

  private void Select(int id, int optionIndex)
  {
    answers[id] = optionIndex;
    // In StepMode, do not advance or notify gating on selection alone; submit happens on CheckCurrent
    if (!StepMode)
    {
      var q = questions[current];
      var has = answers.ContainsKey(q.Id);
      _ = OnAnswerStateChanged.InvokeAsync(has);
      _ = OnAnsweredCountChanged.InvokeAsync(answers.Count);
    }
  }

  // Helpers for InputRadioGroup binding
  private int? GetAnswer(int id)
  {
    return answers.TryGetValue(id, out var a) ? a : (int?)null;
  }

  private void SelectNullable(int id, int? value)
  {
    if (value.HasValue)
    {
      answers[id] = value.Value;
    }
    else
    {
      answers.Remove(id);
    }
    if (!StepMode)
    {
      var q = questions[current];
      var has = answers.ContainsKey(q.Id);
      _ = OnAnswerStateChanged.InvokeAsync(has);
      _ = OnAnsweredCountChanged.InvokeAsync(answers.Count);
    }
  }

  private int CorrectCount => questions.Count(q => answers.TryGetValue(q.Id, out var a) && a == q.CorrectIndex);
  private int UnansweredCount => questions.Count(q => !answers.ContainsKey(q.Id));

  private void OnSubmit()
  {
    submitted = true;
  }

  private void Reset()
  {
    submitted = false;
    answers.Clear();
    committed.Clear();
    _externalPlacement = null;
    _externalTotalCars = 0;
  }

  private void ResetAndStart()
  {
    Reset();
    current = 0;
    stepChecked = false;
    finished = false;
    _startedUtc = DateTime.UtcNow;
    _finishedUtc = null;
    _elapsed = null;
  userProgress = 0; for (int i = 0; i < foes.Length; i++) foes[i] = 0; started = true;
    if (Timed)
    {
      StartTimer();
    }
    // Notify that step 1 is now active
    _ = OnStepStarted.InvokeAsync(current + 1);
    // On a new question start, notify answered state (likely false)
    var q = questions[current];
    var has = answers.ContainsKey(q.Id);
    _ = OnAnswerStateChanged.InvokeAsync(has && !StepMode ? has : false);
    _ = OnAnsweredCountChanged.InvokeAsync(StepMode ? committed.Count : answers.Count);
  }

  private void CheckCurrent()
  {
    stepChecked = true;
    // In StepMode, a submission commits the current question and notifies gating to resume
    if (StepMode)
    {
      var q = questions[current];
      committed.Add(q.Id);
      _ = OnAnswerStateChanged.InvokeAsync(true);
      // Also notify correctness result for game logic (e.g., speed penalty on wrong answers)
      var chosenOk = answers.TryGetValue(q.Id, out var a) && a == q.CorrectIndex;
      _ = OnAnswerChecked.InvokeAsync(chosenOk);
      _ = OnAnsweredCountChanged.InvokeAsync(committed.Count);
    }
  }

  private async Task Next()
  {
  if (current < questions.Count - 1)
    {
      // progress: only correct answers advance the player
      if (answers.TryGetValue(questions[current].Id, out var a) && a == questions[current].CorrectIndex)
      {
        userProgress = Math.Min(1, userProgress + (1.0 / questions.Count));
      }
      // opponents advance a bit each step
      for (int i = 0; i < foes.Length; i++)
      {
        var jitter = 0.8 + _rng.NextDouble() * 0.4; // 0.8..1.2
        foes[i] = Math.Min(1, foes[i] + foeBase[i] * (1.0 / questions.Count) * jitter);
      }
      current++;
      stepChecked = false;
      // Notify new step now visible
      _ = OnStepStarted.InvokeAsync(current + 1);
      var q2 = questions[current];
      var has2 = answers.ContainsKey(q2.Id);
      _ = OnAnswerStateChanged.InvokeAsync(StepMode ? false : has2);
      _ = OnAnsweredCountChanged.InvokeAsync(StepMode ? committed.Count : answers.Count);
    }
    else
    {
      // last question: finalize progress once
      if (answers.TryGetValue(questions[current].Id, out var a) && a == questions[current].CorrectIndex)
      {
        userProgress = Math.Min(1, userProgress + (1.0 / questions.Count));
      }
      for (int i = 0; i < foes.Length; i++)
      {
        var jitter = 0.8 + _rng.NextDouble() * 0.4;
        foes[i] = Math.Min(1, foes[i] + foeBase[i] * (1.0 / questions.Count) * jitter);
      }
      await FinishAsync();
    }
  }

  private void StartTimer()
  {
    StopTimer();
    timeLeft = TimeLimitSeconds;
    _timer = new System.Timers.Timer(1000);
    _timer.Elapsed += async (_, __) =>
    {
      if (finished) { StopTimer(); return; }
      timeLeft = Math.Max(0, timeLeft - 1);
      // advance opponents each tick
      for (int i = 0; i < foes.Length; i++)
      {
        var tickInc = foeBase[i] * (1.0 / (questions.Count * Math.Max(10, TimeLimitSeconds))); // small per-second bumps
        foes[i] = Math.Min(1, foes[i] + tickInc);
      }
      if (timeLeft == 0)
      {
        await FinishAsync();
      }
      await InvokeAsync(StateHasChanged);
    };
    _timer.AutoReset = true;
    _timer.Enabled = true;
  }

  private void StopTimer()
  {
    if (_timer is not null)
    {
      try { _timer.Stop(); _timer.Dispose(); } catch { }
      _timer = null;
    }
  }

  // --- External race integration helpers ---
  public int GetTotalSteps() => questions.Count;
  public int GetFoeCount() => foes.Length;
  private static double Clamp01(double v) => v < 0 ? 0 : (v > 1 ? 1 : v);
  public void SetExternalProgress(double youFraction, IReadOnlyList<double> rivalsFractions)
  {
    userProgress = Clamp01(youFraction);
    for (int i = 0; i < foes.Length; i++)
    {
      var f = (i < rivalsFractions.Count) ? rivalsFractions[i] : 0.0;
      foes[i] = Clamp01(f);
    }
    InvokeAsync(StateHasChanged);
  }

  protected override void OnAfterRender(bool firstRender)
  {
    if (firstRender && StepMode && !started && AutoStart)
    {
      ResetAndStart();
    }
    base.OnAfterRender(firstRender);
  }

  protected override void OnParametersSet()
  {
    // Select questions based on topic and difficulty; default to Cornering/Easy for unknowns.
    var d = (Difficulty ?? "Easy").Trim();
    var t = (Topic ?? "cornering").Trim().ToLowerInvariant();
    var isMedium = d.Equals("Medium", StringComparison.OrdinalIgnoreCase);
    var isHigh = d.Equals("High", StringComparison.OrdinalIgnoreCase);
    if (t == "cornering")
    {
      questions = isHigh ? _highQuestions : (isMedium ? _mediumQuestions : _easyQuestions);
    }
    else if (t == "aerodynamics")
    {
      questions = isHigh ? _aeroHigh : (isMedium ? _aeroMedium : _aeroEasy);
    }
    else if (t == "acceleration")
    {
      questions = isHigh ? _accelHigh : (isMedium ? _accelMedium : _accelEasy);
    }
    else if (t == "topspeed")
    {
      questions = isHigh ? _topHigh : (isMedium ? _topMedium : _topEasy);
    }
    else if (t == "downforce")
    {
      // Downforce topic can reuse the aerodynamics sets to start with
      questions = isHigh ? _aeroHigh : (isMedium ? _aeroMedium : _aeroEasy);
    }
    else
    {
      questions = isHigh ? _highQuestions : (isMedium ? _mediumQuestions : _easyQuestions);
    }
    base.OnParametersSet();
  }

  public void Dispose()
  {
    StopTimer();
  }

  // Allow parent to explicitly start the StepMode flow when AutoStart is false
  public void StartFromParent()
  {
    if (!started)
    {
      ResetAndStart();
    }
  }

  // Emit completion: compute elapsed immediately (quiz duration), but defer showing until parent reveals
  private async Task FinishAsync()
  {
    if (!finished)
    {
      finished = true;
    }
    _finishedUtc ??= DateTime.UtcNow;
    _elapsed = (_startedUtc.HasValue) ? _finishedUtc.Value - _startedUtc.Value : null;
    _showElapsed = false; // hide until race finishes
    StopTimer();
    await InvokeAsync(StateHasChanged);
    try { if (OnFinished.HasDelegate) await OnFinished.InvokeAsync(); } catch { }
  }

  // Called by parent when the race completes its final lap to reveal the elapsed time
  public void RevealElapsed()
  {
    _showElapsed = true;
    InvokeAsync(StateHasChanged);
  }

  // Called by parent to set a specific elapsed value and reveal it (e.g., max of quiz vs. car time)
  public void RevealElapsedWith(TimeSpan elapsed)
  {
    _elapsed = elapsed;
    _showElapsed = true;
    InvokeAsync(StateHasChanged);
  }

  // Called by parent to set the authoritative final placement from the race engine
  public void SetExternalPlacement(int position, int totalCars)
  {
    _externalPlacement = position;
    _externalTotalCars = totalCars;
    InvokeAsync(StateHasChanged);
  }

  private record Question(int Number, string Text, List<string> Options, int CorrectIndex, Func<Question, string>? calculation = null, string? explanationHtml = null)
  {
    public int Id => Number;
    public string LetterFor(int idx) => ((char)('A' + idx)).ToString();
    public string GetExplanationHtml()
    {
      if (calculation is not null)
      {
        return calculation(this);
      }
      return explanationHtml ?? string.Empty;
    }
  }
}
